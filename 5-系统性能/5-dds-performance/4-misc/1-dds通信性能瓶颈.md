# 不同场景下的通信性能

需要考虑中间件在不同场景下的性能

## 参考

[https://blog.joway.io/posts/deep-into-rpc-serialization/](https://blog.joway.io/posts/deep-into-rpc-serialization/)

## 目的

测试的目的是说明不同ros版本, 不同计算平台下的性能

主要版本有melodic, foxy, galactic

主要平台有pc和jetson xavier

验证以下论点：

### ros2对比ros1可以提供更低时延，更少cpu占用率

- zero_copy

- 分布式节点

主要涉及的组件是rmw

主要工作是：

- 中间件开发选型和性能测试

- 在应用程序上验证结果，给出测试结果

### ros2对比ros1可以提供更高可靠性和易用性

- 使用过程中不需要重启

- 日志记录等功能很方便

- ros1的功能都有

主要涉及的组件是rclcpp

主要的工作是：

- ros2版本选型和性能测试

- 提供ros1到ros2迁移的完整指南和移植示例

  - 激光雷达驱动程序

### ros2对比ros1更好支持产品化

- 信息安全

- 实时性支持

- 诊断和状态管理

主要涉及的组件是rclcpp和sros2

主要工作是：

- 提供信息安全的方案和功能开发指南

- 提供实时性支持的软件开发工具流程规范

- 提供软件诊断模块方案和功能开发指南

### ros2对比ros1更好适配jetson设备

- 在arm设备上性能表现不变

主要涉及的组件是jetson设备

主要的工作是：

- 维护jetson软件环境

- 支持和维护在jetson下的ros2代码

## 指标

## 工具

apex的测试工具

时延，总体内存占用

osrf的测试工具

时延，吞吐量，整体CPU占用，局部CPU占用

lttng

测试包括应用程序在内的时延，CPU，内存占用等

<https://github.com/nobleo/ros2_performance>

测试了各个软件模块的CPU占用率

# 分布式系统的性能参数

摘抄自《分布式系统：概念与设计》第五版，ch4网络与网际互连，p47

我们感兴趣的网络性能参数是影响两个互连计算机间消息传输速度的参数，即延迟和点到点的数据传输率。

延迟指的是执行发送操作之后和数据到达目标计算机之前这一段时间。它可以用传输一个空消息的时间来度量。这里我们只考虑网络传输延迟

数据传输率指一旦传输过程开始，数据在网络上两台计算机间传输的速度，通常用bit/s

消息传输时间计算公式

网络的传输速率主要由其物理特征决定的，而延迟则主要由软件开销，路由延迟和负载（源于访问传输信道的冲突性命令）有关。

在分布式系统中的进程之间传输的许多消息的规模很小，因此延迟在决定性能上与数据传输率有相同或者更重要的意义

网络的系统总带宽是度量吞吐量的指标，它表示在给定的时间内网络可以传输的数据总量。在雨多局域网技术中（以太网），每一次数据传输多使用了整个网络的传输容量，这是系统的带宽也就是网络的数据传输率。但在大部分广域网中，消息可以同时在几个不同的信道中传输，这是系统总带宽和传输速率没有直接的关系。

在网络过载时网络性能会恶化，过载是指同时在网络中传输的消息过多。过载给网络的延迟，数据传输率以及系统总带宽锁带来的影响和网络技术紧密相关。

# RPC的时间延迟分析

摘抄自《分布式系统：概念与设计》第五版，ch7操作系统支持，7.5.1调用性能，p179

本节解释了在调用时间上软件的开销会比网络的开销大很多，至少在互联网或企业内部网络上是如此，这与在互联网上的远程调用（例如获得一个Web资源）完全相反。在互联网上，网络延迟通常变化很大，平均值也很高，带宽通常很低，服务器的负载主要花费在对每一个请求的处理上。

统计数据表明，互联网跨地理区域的两台计算机之间最小UDP平均回转时间为400ms，而相同的计算机通过一个以太网，仅需要花费0.1ms

**远程调用开销**，每一种调用机制都导致在调用过程和对象之外的代码被执行，一般每次调用都涉及将参数传递给调用代码的通信，以及将结果返回给调用者的通信。调用机制可是同步的，例如传统调用和远程过程调用，也可以是异步的。

除了是否异步，对调用机制的性能影响最大的因素是是否涉及域转换（是否跨越了地址空间），是否涉及网络通信，以及是否涉及线程调度和切换。

一个传统RPC是需要1us，但是一个跨越网络的RPI需要20ms，但是数据量只有约100Byte，在带宽为100Mbps的网络上，这些数据的传输时间为0.01ms，显然大部分观察到的延迟，来源自操作系统内核代码执行时间和用户级别RPC代码的执行时间开销。

以下为除了网络传输时间外造成远程调用延迟的主要因素：

编码：编码和解码涉及拷贝和转换数据，当数据量增加时，会成为一个显著的开销。（序列化和反序列化）

数据拷贝：即使在编码以后，在一个RPC过程中，消息数据也会多次拷贝：

- 跨越用户-内核边界，在客户或服务器地址空间和内核缓冲区之间（进程间传输）

- 跨越每个协议层时，例如，RPC/UDP/IP/以太网（每个层都会涉及转换）

- 在网络接口和内核缓冲区之间（网络驱动发送数据）

网络接口和主存之间的数据传输方式通常是DMA，其他拷贝则是由处理器处理，所以时间延迟也带来CPU负载

包初始化：涉及初始化协议头部和尾部协议，包括校验和

线程调度和上下文切换：下列情况会带来延迟

- 当存根程序调用内核的通信操作时，在一个RPC过程中会产生几个系统调用（即上下文切换）

- 调度一个或者多个服务线程

- 如果操作系统采用单独的网络管理器进程，在一个RPC过程中会产生几个系统调用

**一个计算机内的RPC开销**，大多数的跨地址空间的调用并不是想像的发生在计算机之间。是可以进行优化的。

分布式多媒体系统的数据传输

摘抄自《分布式系统：概念与设计》第五版，p525

尽管在多媒体系统出现以前实时系统的设计问题就已经被研究过，但是不都没有集成到一个通用的操作系统和网络中。

航空电子设备，航空控制，制造过程控制和电话交换这些已有的实时系统锁执行的任务的本质和多媒体应用程序执行的任务的本质是不同的。前者通常处理的数据量较少，并且硬性截止日期相对较少，如果不能满足这个截止日期，会产生严重甚至是灾难性后果。在这种情况下，解决办法是充分指定计算资源并且为其指定固定的调度计划，以保证最坏的情况下也能满足其需要。这种类型的解决方案对桌面计算机上的大多数互联网多媒体流应用不合适，其一般解决方案为“尽力而为”的服务质量。

服务质量管理，为了满足多媒体和其他应用程序的需要而进行有计划和资源分配和资源调度成为服务质量管理。

大多数当前的操作系统和网络并没有包含支持多媒体应用程序的有保证的服务质量的QoS管理设施。

数据的特征：大量，实时。

# 系统配置

实时内核

linux rt kernel

## 缓冲区配置

![](https://tcs.teambition.net/storage/312dcfeff63ea2164dbe78c3d085bcc7eb74?Signature=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJBcHBJRCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9hcHBJZCI6IjU5Mzc3MGZmODM5NjMyMDAyZTAzNThmMSIsIl9vcmdhbml6YXRpb25JZCI6IiIsImV4cCI6MTY3MTg1MjU0OSwiaWF0IjoxNjcxMjQ3NzQ5LCJyZXNvdXJjZSI6Ii9zdG9yYWdlLzMxMmRjZmVmZjYzZWEyMTY0ZGJlNzhjM2QwODViY2M3ZWI3NCJ9.f1v99ceBx0ceJjTZ46PqrATQENcgfFnW2rnQ831pDXc&download=image.png "")

## 避免节能模式

intel的和arm的都要设置

## 参考

[DDS tuning information — ROS 2 Documentation: Rolling  documentation](https://docs.ros.org/en/rolling/How-To-Guides/DDS-tuning.html)

[https://github.com/christophebedard/ros2_tracing-overhead-evaluation](https://github.com/christophebedard/ros2_tracing-overhead-evaluation)
