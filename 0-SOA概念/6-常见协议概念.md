一文读懂XMPP、DDS、MQTT、AMQP、REST、HTTP协议的区别

# 序言

      物联网终端的种类非常多，包括物联网网关、通信模块以及大量的行业终端，其中尤以行业终端的种类最为丰富。通信模块是物联网应用终端的基础。物联网的行业终端种类繁多，体积、处理能力、对外接口等各不相同，通信模块将成为物联网智能服务通道的统一承载体，嵌入各种行业终端，为各行各业提供物联网的智能通道服务。而在通信中，通信协议尤其重要，是指双方实体完成通信或服务所必须遵循的规则和约定，而且根据终端环境的不同对通信协议的要求完全不一致。

      那么物联网都有哪些通信协议？你都了解吗？他们适用的环境又是如何？

      与互联网时代 TCP/IP，HTTP 一统天下的局面不同，物联网的通信环境有 Ethernet， Wi-Fi， RFID， NFC(近距离无线通信)， Zigbee， 6LoWPAN(IPV6 低速无线版本)，Bluetooth， GSM， GPRS， GPS， 3G， 4G 等网络，而每一种通信应用协议都有一定适用范围。AMQP、JMS、REST/HTTP 都是工作在以太网，COAP 协议是专门为资源受限设备开发的协议，而 DDS 和 MQTT 的兼容性则强很多。

      这儿举个智能家居的例子，说明下这些协议侧重应用方向。智能家居中智能灯光控制，可以使用 XMPP 协议控制灯的开关；智能家居的电力供给，发电厂的发动机组的监控可以使用 DDS 协议；当电力输送到千家万户时，电力线的巡查和维护，可以使用 MQTT 协议；家里的所有电器的电量消耗，可以使用 AMQP 协议，传输到云端或家庭网关中进行分析；最后用户想把自家的能耗查询服务公布到互联网上，那么可以使用 REST/HTTP 来开放 API 服务。

下面我们将一一详细介绍下这些协议：

# 1.REST(松耦合服务调用)

      REST 即表述性状态传递 (英文：Representational State Transfer，简称 REST) 是 Roy Fielding 博士在 2000 年他的博士论文中提出来的一种软件架构风格。它是一种针对网络应用的设计和开发方式，可以降低开发的复杂性，提高系统的可伸缩性。

      而 REST 被应用于物联网主要是基于 HTTP web 服务的转化，因为 REST 模式的 Web 服务与复杂的 SOAP 和 XML-RPC 对比来讲明显的更加简洁，越来越多的 web 服务开始采用 REST 风格设计和实现。

**特点**

- 给一切物体一个 ID

- 连接物体在一起

- 使用标准方法

- 资源多重表述

- 无状态通信

      REST 其实是互联网中服务调用 API 封装风格，物联网中数据采集到物联网应用系统中，在物联网应用系统中，可以通过开放 REST API 的方式，把数据服务开放出去，被互联网中其他应用所调用，所以它非常利于服务平台与物联终端的独立开发，但它的通讯数据量与 API 内容密切相关，且是一种无状态通信，对安全机制需要重新设计。

# 2.COAP 协议

      由于物联网中的很多设备都是资源受限型的，即只有少量的内存空间和有限的计算能力，所以传统的 HTTP 协议应用在物联网上就显得过于庞大而不适用。 IETF 的 CoRE 工作组提出了一种基于 REST 架构的 CoAP 协议。

      CoAP 是一种应用层协议，它运行于 UDP 协议之上而不是像 HTTP 那样运行于 TCP 之上。CoAP 协议非常的小巧，最小的数据包仅为 4 字节。

      CoAP 协议是否可以替换 HTTP 协议?

      CoAP 并不能替代 HTTP 协议，但是对于那些小设备 (256KB Flash 32KB RAM 20MHz 主频) 而言 CoAP 的确是一个好的解决方案。

## CoAP 消息类型

      CoAP 采用和 HTTP 协议相同的请求响应工作模式。CoAP 协议共有 4 中不同的消息类型。

      CON——需要被确认的请求，如果 CON 请求被发送，那么对方必须做出响应。

      NON——不需要被确认的请求，如果 NON 请求被发送，那么对方不必做出回应。

      ACK——应答消息，如果接受到 CON 消息的响应。

      RST——复位消息，当接收者接受到的消息包含一个错误，接受者解析消息或者不再关心发送者发送的内容，那么复位消息将会被发送。

## CoAP 消息结构

      一个 CoAP 消息最小为 4 个字节，以下是 CoAP 协议不同部分的描述。

      【版本 Version】：类似于 IPv6 和 IPv6，仅仅是一个版本号。

      【消息类型 Message Type】：CON，NON，ACK，RST。这些消息类型相当于 HTTP 协议的 PUTGET 等

      【消息 ID Message ID】：每个 CoAP 消息都有一个 ID，在一次会话中 ID 总是保持不变。但是在这个会话之后该 ID 会被回收利用。

      【标记 Token】：标记是 ID 的另一种表现、

      【选项 Options】：CoAP 选项类似于 HTTP 请求头，它包括 CoAP 消息本身，例如 CoAP 端口号，CoAP 主机和 CoAP 查询字符串等。

      【负载 Payload】：真正有用的被交互的数据。

      在当前由 PC 机组成的世界，信息交换是通过 TCP 和应用层协议 HTTP 实现的。但是对于小型设备而言，实现 TCP 和 HTTP 协议显然是一个过分的要求。为了让小设备可以接入互联网，CoAP 协议被设计出来。

# 3.MQTT 协议 (低带宽)

      MQTT(Message Queuing Telemetry Transport，消息队列遥测传输协议)，是一种基于发布 / 订阅 (publish/subscribe) 模式的 “轻量级” 通讯协议，该协议构建于 TCP/IP 协议上，由 IBM 在 1999 年发布。MQTT 最大优点在于，可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。做为一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用。

      MQTT 协议运行在 TCP/IP 或其他网络协议，提供有序、无损、双向连接。其特点包括：

1. 使用的发布 / 订阅消息模式，它提供了一对多消息分发，以实现与应用程序的解耦。

1. 对负载内容屏蔽的消息传输机制。

1. 对传输消息有三种服务质量 (QoS)：

      最多一次，这一级别会发生消息丢失或重复，消息发布依赖于底层 TCP/IP 网络。即：<=1 至多一次，这一级别会确保消息到达，但消息可能会重复。即：>=1

      只有一次，确保消息只有一次到达。即：=1。在一些要求比较严格的计费系统中，可以使用此级别

1. 数据传输和协议交换的最小化 (协议头部只有 2 字节)，以减少网络流量

1. 通知机制，异常中断时通知传输双方

      适用范围：在低带宽、不可靠的网络下提供基于云平台的远程设备的数据传输和监控。

## 协议实现方式

      实现 MQTT 协议需要：客户端和服务器端

      MQTT 协议中有三种身份：发布者 (Publish)、代理 (Broker)(服务器)、订阅者 (Subscribe)。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。

      MQTT 传输的消息分为：主题 (Topic) 和负载 (payload) 两部分

      Topic，可以理解为消息的类型，订阅者订阅 (Subscribe) 后，就会收到该主题的消息内容(payload)

      payload，可以理解为消息的内容，是指订阅者具体要使用的内容

      MQTT 协议一般适用于设备数据采集到端 (Device-》Server，Device-》Gateway)，集中星型网络架构 (hub-and-spoke)，不适用设备与设备之间通信，设备控制能力弱，另外实时性较差，一般都在秒级。

# 4.DDS 协议 (高可靠性、实时)

      数据分发服务 DDS(Data Distribution Service)是对象管理组织 (OMG) 在 HLA 及 CORBA 等标准的基础上制定的新一代分布式实时通信中间件技术规范，DDS 采用发布 / 订阅体系架构，强调以数据为中心，提供丰富的 QoS 服务质量策略，能保障数据进行实时、高效、灵活地分发，可满足各种分布式实时通信应用需求。DDS 信息分发中间件是一种轻便的、能够提供实时信息传送的中间件技术。

**特点：**

- 灵活的发布 / 订阅模式

- 完整 DDS 规范 QoS 服务质量策略

- 已扩展的 QoS 服务质量策略

- 互操作

- 强实时

- 跨平台

- 支持多种底层物理通信协议

- 仿真→测试→实装的全生命周期支持

      DDS 很好地支持设备之间的数据分发和设备控制，设备和云端的数据传输，同时 DDS 的数据分发的实时效率非常高，能做到秒级内同时分发百万条消息到众多设备。DDS 在服务质量 (QoS) 上提供非常多的保障途径，这也是它适用于国防军事、工业控制这些高可靠性、可安全性应用领域的原因。但这些应用都工作在有线网络下，在无线网络，特别是资源受限的情况下，没有见到过实施案例。

# 5.AMQP 协议 (互操作性)

      AMQP，即 Advanced Message Queuing Protocol, 一个提供统一消息服务的应用层标准高级消息队列协议, 是应用层协议的一个开放标准, 为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端 / 中间件不同产品，不同的开发语言等条件的限制。Erlang 中的实现有 RabbitMQ 等。

      AMQP 协议是一个二进制协议，拥有一些现代特点：多信道、协商式、异步、安全、跨平台、中立、高效。

**AMQP 通常被划分为三层：**

      模型层定义了一套命令 (按功能分类)，客户端应用可以利用这些命令来实现它的业务功能。

      会话层负责将命令从客户端应用传递给服务器，再将服务器的应答传递给客户端应用，会话层为这个传递过程提供可靠性、同步机制和错误处理。

      传输层提供帧处理、信道复用、错误检测和数据表示。

      实现者可以将传输层替换成任意传输协议，只要不改变 AMQP 协议中与客户端应用程序相关的功能。实现者还可以使用其他高层协议中的会话层。

      AMQP 协议最早应用于金融系统之间的交易消息传递，在物联网应用中，主要适用于移动手持设备与后台数据中心的通信和分析。

# 6.XMPP 协议 (即时通信)

      XMPP 是一种基于标准通用标记语言的子集 XML 的协议，它继承了在 XML 环境中灵活的发展性。因此，基于 XMPP 的应用具有超强的可扩展性。经过扩展以后的 XMPP 可以通过发送扩展的信息来处理用户的需求，以及在 XMPP 的顶端建立如内容发布系统和基于地址的服务等应用程序。而且，XMPP 包含了针对服务器端的软件协议，使之能与另一个进行通话，这使得开发者更容易建立客户应用程序或给一个配好系统添加功能。

**特点：**

- 客户机 / 服务器通信模式

- 分布式网络

- 简单的客户端，将大多数工作放在服务器端进行

- 标准通用标记语言的子集 XML 的数据格式

      XMPP 协议是自由、开放、公开的，并且易于了解。而且在客户端、服务器、组件、源码库等方面，都已经各自有多种实现。但随着通常超过 70% 的 XMPP 协议的服务器的数据流量的存在和近 60% 的被重复转发，XMPP 协议目前拥有一个大型架空中存在的数据提供给多个收件人。适用于即时通信的应用程序，还能用在网络管理、内容供稿、协同工具、档案共享、游戏、远端系统监控等。

![数据系统](https://udds-portal-public.oss-cn-hangzhou.aliyuncs.com/img/iot.webp "")

# 参考

 南京磐优  2021-6-25
